<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="observation-data">

  <!--  Observations are fetched from the nearest observation station using area name, because 
        there is no support for coordinates. New data is available every 10 minutes -->  
  <template>
    <iron-ajax
      id="weather"
      url="https://data.fmi.fi/fmi-apikey/412facb5-f1bc-44e7-88cc-dc9e08903e32/wfs",
      params="{{_getParams(weatherLocation)}}",
      handle-as="document"
      timeout="8000"></iron-ajax>
  </template>

  <script>
  
  class ObservationData extends Polymer.Element {
      static get is() { return 'observation-data'; }
      
      static get properties() {
        return {
          place: {
            type: Number,
            observer: '_newPlace'
          },
          observationData: {
            type: Object,
            notify: true
          },
        };
      }

      // Lifecycle functions

      ready() {
        super.ready();
      }

      _dispatchEvent(name, payload) {
        const event = new CustomEvent(name, {detail: payload, bubbles: true, composed: true});
        this.dispatchEvent(event);
      }
      
      // other functions alphabetically
      
      _getParams(location){
      
        let params = 
        {
          "request":"getFeature", 
          "storedquery_id":"fmi::observations::weather::simple",
          "geoid": location,
          "starttime": this._timeNowPlusMinutes(-18),
          "endtime": this._timeNow(),
        }

        return params;
      }

      _getObservations(data) {
        let timeNow = new Date();
        timeNow.setMinutes(0,0,0);
        
        const timeISO = timeNow.toISOString().split('.')[0]+"Z";
        return timeISO;
      }
      
      /**
       *<wfs:FeatureCollection>
        <wfs:member>
          <BsWfs:BsWfsElement gml:id="BsWfsElement.1.1.1">
            <BsWfs:Location>
              <gml:Point gml:id="BsWfsElementP.1.1.1" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4258">
                <gml:pos>60.17802 24.78732 </gml:pos>
              </gml:Point>
            </BsWfs:Location>
            <BsWfs:Time>2018-03-30T17:30:00Z</BsWfs:Time>
            <BsWfs:ParameterName>t2m</BsWfs:ParameterName>
            <BsWfs:ParameterValue>-2.0</BsWfs:ParameterValue>
          </BsWfs:BsWfsElement>
        </wfs:member>
	      <wfs:member>
		      <BsWfs:BsWfsElement gml:id="BsWfsElement.1.1.2">
            ...
            <BsWfs:ParameterName>ws_10min</BsWfs:ParameterName>
            <BsWfs:ParameterValue>2.0</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>wg_10min</BsWfs:ParameterName>
            <BsWfs:ParameterValue>2.6</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>wd_10min</BsWfs:ParameterName>
			      <BsWfs:ParameterValue>65.0</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>rh</BsWfs:ParameterName>
            <BsWfs:ParameterValue>56.0</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>td</BsWfs:ParameterName>
            <BsWfs:ParameterValue>-9.6</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>r_1h</BsWfs:ParameterName>
			      <BsWfs:ParameterValue>NaN</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>ri_10min</BsWfs:ParameterName>
            <BsWfs:ParameterValue>0.0</BsWfs:ParameterValue>
            ...
		    	  <BsWfs:ParameterName>snow_aws</BsWfs:ParameterName>
            <BsWfs:ParameterValue>21.0</BsWfs:ParameterValue>
            ...
		      	<BsWfs:ParameterName>p_sea</BsWfs:ParameterName>
			      <BsWfs:ParameterValue>1012.6</BsWfs:ParameterValue>
            ...
            <BsWfs:ParameterName>vis</BsWfs:ParameterName>
			      <BsWfs:ParameterValue>50000.0</BsWfs:ParameterValue>
		
       * 
       * And it is converted to the following JSON and stored into this.observationData 
       * 
       *    {temperature: '-1', time: "2018-03-02T23:00:00Z", wind: NaN, windDirection: NaN}
       * 
       *   wd_10min = tuulen suunta
       *   wawa = säätila
       *   ws_10min = tuulen nopeus
       *   wg_10min = puuskatuuli
       *   p_sea = ilmanpaine
       *   rh = ilmankosteus
       *   t2m = lämpötila
       *   r_1h = 1h sademäärä
       *   ri_10min = sateen rankkuus
       *   snow_aws = lumen syvyys niiltä asemilta jossa se on -->
       *   
       */
       _handleResponse(request) {
        
        const time = this._value(request.response.getElementsByTagName('BsWfs:Time')[0]);
        const values = request.response.getElementsByTagName('BsWfs:ParameterValue');
        
        this.observationData = {
          time: time,
          temperature: parseFloat(this._value(values[0])),
          wind: parseFloat(this._value(values[1])),
          windDirection: parseFloat(this._value(values[3]))
        }
      }

      _newPlace() {
        this.$.weather.params = this._getParams(this.place.location.geoid);
        
        this.$.weather.generateRequest().completes
          .then(req => {
            this._handleResponse(req);
          })
          .catch(rejected => {
            this._dispatchEvent('observation-data.fetch-error', {text: 'Virhe haettaessa ennustetietoja'});
            console.log('error ' + rejected.error);
          });
      }

      _tenMinutesAgo() {
        let now = new Date();
        return firstHour.toISOString();
      }

      _timeNow() {
        const now = new Date();
        return now.toISOString();
      }

      _timeNowPlusMinutes(minutes) {
        const date = new Date();  
        const calculatedTime = new Date(date.getTime() + minutes*60000);
        
        return calculatedTime.toISOString();
      }

      _value(xmlElement) {
        return xmlElement.childNodes[0].nodeValue;
      }
    }

    window.customElements.define(ObservationData.is, ObservationData);
  </script>
</dom-module>
